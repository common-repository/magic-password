!function(r,e,s){try{var n=r(".mf-js-session-id"),o=r(".mf-js-integration-id"),i=r(".mf-js-integration-user-id"),a=r(".mf-js-totp-code"),c=r(".mf-js-channel-name"),d=r(".mf-js-status-id"),u=r("#loginform"),l=r('.mf-js-configuration-token > input[name="_wpnonce"]'),f=r(".mf-js-totp-secret"),m=r(".mf-success-modal"),p=!1,t=!0,g=r(".mf-js-handle-focus"),h=r(".mf-js-login-config-qr-code-form"),v=r(".mf-action-name"),w=r(".mf-qr-code-wrapper"),b=r(".mf-js-show-qr"),j=r(".mf-qr-code-placeholder"),_=!1;function C(){w.addClass("mf-loading")}function q(e,n,o){r(document).trigger("receivedCode"),c.val(o),d.val(n.statusId),a.val(n.totpToken),h.length?(C(),e.disconnect(),h.submit()):function(e,n,o,t){var i={totp_secret:f.val(),totp_code:n,channel_name:o,status_id:t,_wpnonce:l.val()};r.ajax({type:"POST",url:mpwdPusher.pairEndpoint,data:i}).done(function(){m.trigger("mf-modal-open")}).fail(function(e){var n=JSON.parse(e.responseText).error;Sentry.captureMessage("Pair error",{extra:{channel_name:o,error:n,status:e.status}}),s.showErrorModal(n)}).always(function(){e.disconnect()})}(e,n.totpToken,o,n.statusId)}function k(n,o,t){var e=n.subscribe(o);e.bind("login-request",function(e){!function(e,n,o){C(),r(document).trigger("receivedCode"),c.val(o),d.val(n.statusId),i.val(n.integrationUserId),a.val(n.totpToken),v.val("passwordless-login"),e.disconnect(),u.submit()}(n,e,o)}),e.bind("configuration-request",function(e){q(n,e,o)}),e.bind("pusher:subscription_error",function(e){!function(e,n,o,t){(function(e){return 0===e})(e)||(t<3?k(n,o,++t):(Sentry.captureMessage("Subscription error",{extra:{channel_name:o,status:e}}),s.showErrorModal("Subscription error ("+e+")")))}(e,n,o,t)}),e.bind("pusher:subscription_succeeded",function(){p=!0,w.removeClass("mf-loading"),_&&T()})}function E(){if(!p){k(new Pusher(mpwdPusher.pusherKey,{forceTLS:!0,authEndpoint:mpwdPusher.authenticateEndpoint,auth:{params:{session_id:n.val()},headers:{"X-Requested-With":"XMLHttpRequest"}}}),"private-wp_"+o.val()+"_"+n.val(),1)}}function y(){return r(".mf-login").length&&(v.length&&"login-configuration"===v.val()||v.length&&"passwordless-login"===v.val())}function S(){return r(".mf-login").length&&-1<document.cookie.search("mpwd_login=1")}function T(){j.hide(),r(".mf-qr-code").removeClass("mf-qr-code-hide"),b.text("MAGIC CODE READY"),b.prop("disabled",!0)}r(".mf-js-subscribe-pusher-channel").on("click",E),b.click(function(e){e.preventDefault(),p?T():(_=!0,j.hide(),r(this).text("LOADING").prop("disabled",!0),r(".mf-qr-code-wrapper").addClass("mf-loading"),E())}),(r(".mf-not-configured").length||S()||y()||r(".magic-button").is(":visible"))&&E(),g.on("click",function(){g.addClass("mf-link-disabled"),r(window).on("focus",function(){r(document).trigger("waitingForCode")})}),r(document).on("waitingForCode",function(){setTimeout(function(){g.removeClass("mf-link-disabled"),t&&e.showToast("Request not received.")},2e3)}),r(document).on("receivedCode",function(){t=!1})}catch(e){Sentry.captureException(e),s.showErrorModal(e.message)}}(jQuery,mpwdDashboard.toaster,mpwdDashboard.modal);